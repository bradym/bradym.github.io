<!doctype html><html lang=en><head><title>Logging requests with MySQL ::
Wandering Thoughts</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="One of my recent work projects was publishing a widget which others can add to their websites by copying some code and using it on their site. Similar to how YouTube  makes it easy to embed their videos elsewhere.
Of course we want to know how and where this widget is being used so we can decide if it&amp;rsquo;s worth doing more widgets in the future, so we needed to include tracking."><meta name=keywords content="mysql,,simple,application,logging"><meta name=robots content="noodp"><link rel=canonical href=https://www.bradym.net/mysql/logging-requests-with-mysql.html><link rel=stylesheet href=https://www.bradym.net/assets/style.css><link rel=stylesheet href=https://www.bradym.net/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://www.bradym.net/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://www.bradym.net/img/favicon.png><link href=https://www.bradym.net/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://www.bradym.net/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://www.bradym.net/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://www.bradym.net/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://www.bradym.net/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://www.bradym.net/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Logging requests with MySQL"><meta name=twitter:description content="Trying to setup a simple activity log using MySQL?  Using this techniquie it's easy to get a count of actions performed on your site."><meta property="og:title" content="Logging requests with MySQL"><meta property="og:description" content="Trying to setup a simple activity log using MySQL?  Using this techniquie it's easy to get a count of actions performed on your site."><meta property="og:type" content="article"><meta property="og:url" content="https://www.bradym.net/mysql/logging-requests-with-mysql.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2008-07-12T00:00:00+00:00"><meta property="article:modified_time" content="2008-07-12T00:00:00+00:00"><meta property="og:site_name" content="Wandering Thoughts"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>wandering thoughts</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/tags/>Tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/tags/>Tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Logging requests with MySQL</h1><div class=post-meta><span class=post-date>2008-07-12</span></div><span class=post-tags><a href=https://www.bradym.net/tags/mysql/>#MySQL</a>&nbsp;</span><div class=post-content><p>One of my recent work projects was publishing a widget which others can add to their websites by copying some code and using it on their site. Similar to how <a href=http://youtube.com target=_blank>YouTube</a> makes it easy to embed their videos elsewhere.</p><p>Of course we want to know how and where this widget is being used so we can decide if it&rsquo;s worth doing more widgets in the future, so we needed to include tracking. What we want to know is where the widget is being used, and how many times it is being displayed on those URLs.</p><p>The tracking table is very simple:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> widget_impressions (
</span></span><span style=display:flex><span>    id int(<span style=color:#ae81ff>11</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> auto_increment,
</span></span><span style=display:flex><span>    referral_url varchar(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    counter int(<span style=color:#ae81ff>11</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    date_created date <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>  (referral_url,date_created),
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>KEY</span> id (id)
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>Technically, the id column is not needed since the primary key is a
combination of the referral_url and the date_viewed field, but it can
be handy in some situations.</p><p>When the widget is displayed, the following query is run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> widget_impressions
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>SET</span>
</span></span><span style=display:flex><span>        referral_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://example.com&#39;</span>,
</span></span><span style=display:flex><span>        date_viewed <span style=color:#f92672>=</span> now(),
</span></span><span style=display:flex><span>        counter <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ON</span> DUPLICATE <span style=color:#66d9ef>KEY</span> <span style=color:#66d9ef>UPDATE</span>
</span></span><span style=display:flex><span>        counter <span style=color:#f92672>=</span> counter <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span></code></pre></div><p>If this is the first visit from <a href=http://example.com target=_blank>http://example.com</a> for the day, a new record will be added to the table. If it&rsquo;s not the first record for the day, the counter will be incremented by one. Using the date type for the date_viewed field means only the date is stored, not the time. If a datetime field were used, this method would not work the same way; we&rsquo;d have separate entries in the table every time someone viewed the widget.</p><p>With this table structure it&rsquo;s very easy to get stats. Say you want to know all of the pages where the widget is displayed and how many times it has been displayed on each:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> referral_url, <span style=color:#66d9ef>SUM</span>(counter) <span style=color:#66d9ef>as</span> num_views <span style=color:#66d9ef>FROM</span> widget_impressions <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> referral_url;
</span></span></code></pre></div><p>Want to know the 10 sites that are displaying your widget the most?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> referral_url, <span style=color:#66d9ef>SUM</span>(counter) <span style=color:#66d9ef>as</span> num_views <span style=color:#66d9ef>FROM</span> widget_impressions <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> referral_url <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> num_views <span style=color:#66d9ef>DESC</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>;
</span></span></code></pre></div><p><strong>References:</strong></p><ul><li><a href=http://bradym.net/mysql/on-duplicate-key-update target=_blank>MySQL - on duplicate key update</a></li><li><a href=http://dev.mysql.com/doc/refman/5.0/en/date-and-time-type-overview.html target=_blank>Overview of Date and Time Types</a></li><li><a href=http://dev.mysql.com/doc/refman/5.0/en/date-and-time-functions.html#function_now target=_blank>now()</a></li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://www.bradym.net/windows/testing-in-multiple-versions-of-ie.html><span class=button__icon>←</span>
<span class=button__text>Testing in multiple versions of IE</span></a></span>
<span class="button next"><a href=https://www.bradym.net/mysql/on-duplicate-key-update.html><span class=button__text>MySQL - on duplicate key update</span>
<span class=button__icon>→</span></a></span></div></div><div style=padding-top:15px><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bradymnet.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>wandering thoughts</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2022<span></span></div></div></footer><script src=https://www.bradym.net/assets/main.js></script>
<script src=https://www.bradym.net/assets/prism.js></script></div></body></html>